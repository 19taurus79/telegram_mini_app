/**
 * @file D:/Projects/GOIT JS Course/Next/for_test/store/Delivery.ts
 * @description Этот файл определяет хранилище (store) Zustand для управления состоянием "корзины доставки".
 * Хранилище отвечает за добавление, обновление и удаление товаров, которые готовятся к отправке.
 * Используется `persist` middleware для сохранения состояния в localStorage, чтобы данные не терялись при перезагрузке страницы.
 */

import { create } from "zustand";
import { persist } from "zustand/middleware";

/**
 * Описывает партию товара, которая будет отгружена.
 */
type Party = {
  /** Количество товара, которое отгружается из этой партии. */
  moved_q: number;
  /** Идентификатор или название партии. */
  party: string;
};

/**
 * Описывает один элемент (товар) в корзине доставки.
 * Содержит всю необходимую информацию о товаре для его дальнейшей обработки и отправки.
 */
type DeliveryItem = {
  /** Название товара, видимое пользователю. */
  product: string;
  /** Номенклатурное название товара для бэкенда. */
  nomenclature: string;
  /** Количество товара, которое пользователь хочет добавить в доставку. */
  quantity: number;
  /** Имя клиента (контрагента). */
  client: string;
  /** Имя менеджера, ответственного за клиента. */
  manager: string;
  /** Номер заказа или дополнения к контракту. */
  order: string;
  /** Уникальный идентификатор элемента (часто совпадает с ID товара в заказе). */
  id: string;
  /** Массив партий, из которых будет отгружаться этот товар. */
  parties: Party[];
  /** Общее количество этого товара, заказанное клиентом (максимально доступное для доставки). */
  orders_q: number;
  /** Количество по бухгалтерскому учету. */
  buh: number;
  /** Количество на складе. */
  skl: number;
  /** Качество/состояние товара. */
  qok: string;
  /** Вес одной единицы товара (может быть средним). */
  weight?: number;
};

/**
 * Определяет структуру состояния и действий (actions) для хранилища доставки.
 */
type DeliveryState = {
  /** Массив товаров, находящихся в корзине доставки. */
  delivery: DeliveryItem[];
  /** Действие для добавления или удаления товара из корзины. */
  setDelivery: (item: DeliveryItem) => void;
  /** Действие для обновления количества конкретного товара в корзине. */
  updateQuantity: (id: string, quantity: number) => void;
  /** Действие для полной очистки корзины доставки. */
  clearDelivery: () => void;
  /** Действие для удаления всех товаров, связанных с конкретным клиентом. */
  removeClientDelivery: (client: string) => void;
  /** Селектор для проверки, находится ли товар с указанным ID уже в корзине. */
  hasItem: (id: string) => boolean;
};

/**
 * `useDelivery` - это кастомный хук для доступа к хранилищу состояния доставки.
 * Он создан с помощью `create` из Zustand и обернут в `persist` для сохранения в localStorage.
 */
export const useDelivery = create<DeliveryState>()(
  // `persist` - это middleware, которое автоматически сохраняет состояние в localStorage
  // и восстанавливает его при инициализации приложения.
  persist(
    (set, get) => ({
      // Массив товаров, добавленных в корзину доставки.
      delivery: [],

      // Добавляет товар в корзину, если его там нет, или удаляет, если он уже есть (работает как toggle).
      setDelivery: (item) =>
        set((state) => {
          // Проверяем, есть ли уже товар в корзине, используя селектор `hasItem`
          if (get().hasItem(item.id)) {
            // Если товар есть, удаляем его, фильтруя массив
            return {
              delivery: state.delivery.filter((d) => d.id !== item.id),
            };
          } else {
            // Если товара нет, добавляем его в конец массива
            return { delivery: [...state.delivery, item] };
          }
        }),

      // Обновляет количество для конкретного товара в корзине.
      updateQuantity: (id, quantity) =>
        set((state) => ({
          delivery: state.delivery.map((item) =>
            // Находим нужный товар по ID и обновляем его поле `quantity`
            item.id === id ? { ...item, quantity } : item
          ),
        })),

      // Полностью очищает корзину доставки, устанавливая пустой массив.
      clearDelivery: () => set({ delivery: [] }),

      // Удаляет из корзины все товары, принадлежащие указанному клиенту.
      // Это полезно после успешного оформления доставки для одного клиента.
      removeClientDelivery: (client) =>
        set((state) => ({
          delivery: state.delivery.filter((item) => item.client !== client),
        })),

      // Селектор для проверки наличия товара в корзине по его ID.
      hasItem: (id) => get().delivery.some((item) => item.id === id),
    }),
    {
      // Имя ключа, под которым состояние будет сохранено в localStorage.
      name: "delivery-storage",
    }
  )
);
